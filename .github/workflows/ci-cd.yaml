name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      # Ne déclenche que si ces fichiers changent
      - 'frontend/**'
      - 'event/**'
      - 'group/**'
      - 'rating/**'
      - 'safety/**'
      - 'user/**'
      - 'helm/**'
      - 'moderation/**'
      - '.github/workflows/ci-cd.yaml'
  # Pull requests: only run tests, no builds
  pull_request:
    branches:
      - main

# Permissions pour tout le workflow
permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/titouanpastor/crewup

jobs:
  # Détecte quels services ont changé
  detect-changes:
    runs-on: ubuntu-latest
    # Only run on push to main (skip on PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      event: ${{ steps.changes.outputs.event }}
      group: ${{ steps.changes.outputs.group }}
      rating: ${{ steps.changes.outputs.rating }}
      safety: ${{ steps.changes.outputs.safety }}
      user: ${{ steps.changes.outputs.user }}
      any_service: ${{ steps.changes.outputs.frontend == 'true' || steps.changes.outputs.event == 'true' || steps.changes.outputs.group == 'true' || steps.changes.outputs.rating == 'true' || steps.changes.outputs.safety == 'true' || steps.changes.outputs.user == 'true' }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
            event:
              - 'event/**'
            group:
              - 'group/**'
            rating:
              - 'rating/**'
            safety:
              - 'safety/**'
            user:
              - 'user/**'
            moderation:
              - 'moderation/**'

  # Build et push seulement les images qui ont changé
  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.any_service == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [frontend, event, group, rating, safety, user]
        # Include/exclude basé sur les changements détectés
        include:
          - service: frontend
          - service: event
          - service: group
          - service: rating
          - service: safety
          - service: user
          - service: moderation
    # Skip si ce service spécifique n'a pas changé
    steps:
      - name: Check if service changed
        id: should_build
        run: |
          if [[ "${{ matrix.service }}" == "frontend" && "${{ needs.detect-changes.outputs.frontend }}" == "true" ]] || \
             [[ "${{ matrix.service }}" == "event" && "${{ needs.detect-changes.outputs.event }}" == "true" ]] || \
             [[ "${{ matrix.service }}" == "group" && "${{ needs.detect-changes.outputs.group }}" == "true" ]] || \
             [[ "${{ matrix.service }}" == "rating" && "${{ needs.detect-changes.outputs.rating }}" == "true" ]] || \
             [[ "${{ matrix.service }}" == "safety" && "${{ needs.detect-changes.outputs.safety }}" == "true" ]] || \
             [[ "${{ matrix.service }}" == "user" && "${{ needs.detect-changes.outputs.user }}" == "true" ]] || \
             [[ "${{ matrix.service }}" == "moderation" && "${{ needs.detect-changes.outputs.moderation }}" == "true" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Checkout code
        if: steps.should_build.outputs.should_build == 'true'
        uses: actions/checkout@v4
      
      - name: Set up image tag
        if: steps.should_build.outputs.should_build == 'true'
        id: tag
        run: echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
      
      - name: Login to GitHub Container Registry
        if: steps.should_build.outputs.should_build == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push ${{ matrix.service }}
        if: steps.should_build.outputs.should_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: ${{ github.event_name == 'push' }}
          tags: |
            ${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:${{ env.IMAGE_TAG }}
            ${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:latest

  # Update DEV environment values with new image tags
  update-dev-values:
    needs: [detect-changes, build-and-push]
    # Ne update que si des services ont changé
    if: github.event_name == 'push' && needs.detect-changes.outputs.any_service == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}  # Utilise PAT au lieu de GITHUB_TOKEN
          fetch-depth: 0  # Fetch all history for proper pull
      
      - name: Set up image tag
        id: tag
        run: echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
      
      - name: Update DEV image tags for changed services
        run: |
          CHANGED_SERVICES=""
          
          # Frontend
          if [[ "${{ needs.detect-changes.outputs.frontend }}" == "true" ]]; then
            sed -i "s/^\(  imageTag: \).*/\1\"${{ env.IMAGE_TAG }}\"/" environments/dev/values.yaml
            CHANGED_SERVICES="$CHANGED_SERVICES frontend"
          fi
          
          # Event service
          if [[ "${{ needs.detect-changes.outputs.event }}" == "true" ]]; then
            sed -i "/^  event:/,/^  [a-z]/ s/^\(    imageTag: \).*/\1\"${{ env.IMAGE_TAG }}\"/" environments/dev/values.yaml
            CHANGED_SERVICES="$CHANGED_SERVICES event"
          fi
          
          # Group service
          if [[ "${{ needs.detect-changes.outputs.group }}" == "true" ]]; then
            sed -i "/^  group:/,/^  [a-z]/ s/^\(    imageTag: \).*/\1\"${{ env.IMAGE_TAG }}\"/" environments/dev/values.yaml
            CHANGED_SERVICES="$CHANGED_SERVICES group"
          fi
          
          # Rating service
          if [[ "${{ needs.detect-changes.outputs.rating }}" == "true" ]]; then
            sed -i "/^  rating:/,/^  [a-z]/ s/^\(    imageTag: \).*/\1\"${{ env.IMAGE_TAG }}\"/" environments/dev/values.yaml
            CHANGED_SERVICES="$CHANGED_SERVICES rating"
          fi
          
          # Safety service
          if [[ "${{ needs.detect-changes.outputs.safety }}" == "true" ]]; then
            sed -i "/^  safety:/,/^  [a-z]/ s/^\(    imageTag: \).*/\1\"${{ env.IMAGE_TAG }}\"/" environments/dev/values.yaml
            CHANGED_SERVICES="$CHANGED_SERVICES safety"
          fi
          
          # User service
          if [[ "${{ needs.detect-changes.outputs.user }}" == "true" ]]; then
            sed -i "/^  user:/,/^  [a-z]/ s/^\(    imageTag: \).*/\1\"${{ env.IMAGE_TAG }}\"/" environments/dev/values.yaml
            CHANGED_SERVICES="$CHANGED_SERVICES user"
          fi
          
          # User service
          if [[ "${{ needs.detect-changes.outputs.moderation }}" == "true" ]]; then
            sed -i "/^  moderation:/,/^  [a-z]/ s/^\(    imageTag: \).*/\1\"${{ env.IMAGE_TAG }}\"/" environments/dev/values.yaml
            CHANGED_SERVICES="$CHANGED_SERVICES moderation"
          fi
          
          echo "CHANGED_SERVICES=$CHANGED_SERVICES" >> $GITHUB_ENV
      
      - name: Commit and push DEV values
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          git add environments/dev/values.yaml
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Pull latest changes with rebase (stash if needed)
            git pull --rebase --autostash origin main
            
            git commit -m "chore(dev): update image tags to ${{ env.IMAGE_TAG }} [${{ env.CHANGED_SERVICES }}] [skip ci]"
            git push origin main
          fi
