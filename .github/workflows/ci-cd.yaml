name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'event/**'
      - 'group/**'
      - 'rating/**'
      - 'safety/**'
      - 'user/**'
      - '.github/workflows/ci-cd.yaml'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/titouanpastor/crewup

jobs:
  # Détecte quels services ont changé pour ne build que ceux-là
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      event: ${{ steps.filter.outputs.event }}
      group: ${{ steps.filter.outputs.group }}
      rating: ${{ steps.filter.outputs.rating }}
      safety: ${{ steps.filter.outputs.safety }}
      user: ${{ steps.filter.outputs.user }}
      image_tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
            event:
              - 'event/**'
            group:
              - 'group/**'
            rating:
              - 'rating/**'
            safety:
              - 'safety/**'
            user:
              - 'user/**'
      
      - name: Generate image tag
        id: tag
        run: echo "tag=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

  # Build et push l'image frontend
  build-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-frontend:${{ needs.detect-changes.outputs.image_tag }}
            ${{ env.IMAGE_PREFIX }}-frontend:latest

  # Build et push les microservices
  build-services:
    needs: detect-changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [event, group, rating, safety, user]
    # Ne build que si le service a changé
    if: needs.detect-changes.outputs[matrix.service] == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:${{ needs.detect-changes.outputs.image_tag }}
            ${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:latest

  # Update Helm values.yaml avec les nouveaux tags
  update-helm-values:
    needs: [detect-changes, build-frontend, build-services]
    # Toujours run même si certains jobs sont skippés
    if: always() && needs.detect-changes.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update image tag in values.yaml
        run: |
          sed -i "s/imageTag: .*/imageTag: ${{ needs.detect-changes.outputs.image_tag }}/" helm/crewup/values.yaml
      
      - name: Commit and push if changed
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add helm/crewup/values.yaml
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update image tag to ${{ needs.detect-changes.outputs.image_tag }} [skip ci]"
            git push
          fi
