name: Tests

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

# Cancel previous runs on new push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Run tests for each microservice
  test-services:
    name: Test ${{ matrix.service }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false  # Continue testing other services even if one fails
      matrix:
        service: [event, group, safety, user, rating, moderation]
    
    # PostgreSQL service container
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: crewup_test
          POSTGRES_USER: crewup_test
          POSTGRES_PASSWORD: test_password_123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '${{ matrix.service }}/requirements.txt'
      
      - name: Initialize database with schema
        env:
          PGPASSWORD: test_password_123
        run: |
          # Wait for PostgreSQL to be ready
          until pg_isready -h localhost -p 5432 -U crewup_test; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          
          # Apply schema
          psql -h localhost -U crewup_test -d crewup_test -f helm/crewup/config/schema.sql
          
          # Apply migrations
          for migration in helm/crewup/config/migrations/*.sql; do
            if [ -f "$migration" ]; then
              echo "Applying migration: $migration"
              psql -h localhost -U crewup_test -d crewup_test -f "$migration"
            fi
          done
          
          echo "‚úì Database initialized successfully"
      
      - name: Install dependencies for ${{ matrix.service }}
        working-directory: ./${{ matrix.service }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx
      
      - name: Create test environment file
        working-directory: ./${{ matrix.service }}
        run: |
          cat > .env.test << EOF
          DATABASE_URL=postgresql://crewup_test:test_password_123@localhost:5432/crewup_test
          KEYCLOAK_URL=http://mock-keycloak.local
          KEYCLOAK_REALM=crewup
          KEYCLOAK_CLIENT_ID=crewup-test
          KEYCLOAK_CLIENT_SECRET=test-secret
          TESTING=true
          EOF
      
      - name: Run tests for ${{ matrix.service }}
        working-directory: ./${{ matrix.service }}
        env:
          DATABASE_URL: postgresql://crewup_test:test_password_123@localhost:5432/crewup_test
          TEST_DATABASE_URL: postgresql://crewup_test:test_password_123@localhost:5432/crewup_test
          TESTING: "true"
          CI: "true"
        run: |
          if [ -f "run_tests.sh" ]; then
            chmod +x run_tests.sh
            # Run unit tests only (skip integration tests requiring external services)
            ./run_tests.sh unit 2>/dev/null || pytest tests/ -v --tb=short --cov=app --cov-report=term --ignore=tests/test_integration.py --ignore=tests/test_integration_auth.py 2>/dev/null || pytest tests/ -v --tb=short --cov=app --cov-report=term
          else
            # For services without run_tests.sh, run all tests
            pytest tests/ -v --tb=short --cov=app --cov-report=term
          fi
      
      - name: Generate coverage report
        if: always()
        working-directory: ./${{ matrix.service }}
        run: |
          # Generate coverage summary for this service
          if [ -f ".coverage" ]; then
            coverage report --format=markdown > coverage-report.md || echo "No coverage data" > coverage-report.md
          else
            echo "No coverage data available" > coverage-report.md
          fi
      
      - name: Upload coverage markdown
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-md-${{ matrix.service }}
          path: ${{ matrix.service }}/coverage-report.md
          if-no-files-found: ignore
      
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.service }}
          path: ${{ matrix.service }}/htmlcov/
          if-no-files-found: ignore

  # Summary job - required for branch protection
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test-services
    if: always()
    
    steps:
      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-md-*
          path: coverage-reports
      
      - name: Display coverage in summary
        if: always()
        run: |
          echo "# üìä Test Results & Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.test-services.result }}" == "success" ]; then
            echo "## ‚úÖ All microservice tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Coverage for each service
          echo "## Coverage by Service" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for service in event group safety user rating moderation; do
            coverage_file="coverage-reports/coverage-md-${service}/coverage-report.md"
            if [ -f "$coverage_file" ]; then
              echo "### üì¶ ${service^} Service" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat "$coverage_file" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            else
              echo "### üì¶ ${service^} Service" >> $GITHUB_STEP_SUMMARY
              echo "No coverage data available" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
      
      - name: Check test results
        run: |
          if [ "${{ needs.test-services.result }}" != "success" ]; then
            echo "‚ùå Some tests failed!"
            exit 1
          fi
          echo "‚úÖ All tests passed!"
